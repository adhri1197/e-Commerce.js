const userModel = require("../models/users_model.js");
const validator = require("validator");
const bcrypt = require("bcrypt");
const jwt = require("jsonwebtoken");
const generateToken = require("../utils/generateToken")

exports.registerUser =  async function (req, res) {
    try {
        let { fullname, email, password } = req.body;

        //  Check if all fields are provided
        if (!fullname || !email || !password) {
            req.flash("error", "All fields are required");
            return res.redirect("/")
        }

        // Validate email format
        if (!validator.isEmail(email)) {
            req.flash("error", "Invalid email format");
            return res.redirect("/")
        }

        // Validate password strength
        if (password.length < 8) {
            req.flash("error", "Password must be at least 8 characters long");
            return res.redirect("/")
        }

        // Check if user already exists
        let existingUser = await userModel.findOne({ email });
        if (existingUser) {
            req.flash("error", "User already exists with this email");
            return res.redirect("/")
        }

        // Hash password
        const salt = await bcrypt.genSalt(10);
        const hashedPassword = await bcrypt.hash(password, salt);

        // Create user
        let user = await userModel.create({
            fullname,
            email,
            password: hashedPassword,
        });

        // Remove password from response
        user.password = undefined;
        let token = generateToken(user);
        res.cookie("token", token, { httpOnly: true });
       
        req.flash("success", "Registration successful");
        return res.redirect("/");        

    } catch (err) {
        console.error(err.message);
       res.flash("error", "Server error");
       return res.redirect("/")
    }
}
 
exports.loginUser = async function (req, res) {
    try {
        let { email, password } = req.body;

        if (!email || !password) {
            req.flash("error", "Email and password are required");
            return res.redirect("/");
        }

        let user = await userModel.findOne({ email });
        if (!user) {
            req.flash("error", "User not found");
            return res.redirect("/");
        }

        let isMatch = await bcrypt.compare(password, user.password);
        if (!isMatch) {
            req.flash("error", "Invalid credentials");
            return res.redirect("/");
        }

        const token = generateToken(user);

        req.flash("success", "Login successful");
        res.cookie("token", token, { httpOnly: true });
        return res.redirect("/shop");

    } catch (err) {
        console.error(err);
        req.flash("error", "Server error");
        return res.redirect("/");
    }
};

exports.logoutUser = function (req, res){
    res.clearCookie("token");
    req.flash("success", "Logged out successfully");
    res.redirect("/")
}